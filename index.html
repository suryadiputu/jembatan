<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Peta Aset Jembatan</title>

<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<link rel="stylesheet"
href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>

<link rel="stylesheet"
href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>

<style>

body{
margin:0;
font-family:Segoe UI,Arial;
background:#f5f7fa;
}

#map{
height:92vh;
}

/* TOPBAR */

.topbar{
position:absolute;
top:10px;
left:50%;
transform:translateX(-50%);
background:white;
padding:10px 14px;
border-radius:10px;
box-shadow:0 3px 10px rgba(0,0,0,0.2);
display:flex;
gap:8px;
z-index:1000;
}

.select2-container{
width:260px !important;
}

/* BUTTON */

.btn{
border:none;
padding:8px 14px;
border-radius:6px;
font-weight:600;
cursor:pointer;
}

.btn-go{
background:#0d6efd;
color:white;
}

.btn-gps{
background:#198754;
color:white;
}

.btn-filter{
background:#6c757d;
color:white;
}


/* TOOLTIP */

.bridge-label{
font-size:12px;
font-weight:bold;
background:rgba(255,255,255,0.95);
padding:2px 6px;
border-radius:4px;
}


/* POPUP */

.popup-content{
font-size:14px;
line-height:1.6;
}


/* GMAPS */

.leaflet-popup-content .gmaps-btn{
display:inline-block;
padding:8px 14px;
background:#0d6efd;
color:white !important;
text-decoration:none;
border-radius:6px;
font-size:13px;
font-weight:600;
}


/* FILTER WINDOW */

.filterWindow{

position:absolute;

top:70px;

left:50%;

transform:translateX(-50%);

background:white;

padding:15px;

border-radius:12px;

box-shadow:0 6px 18px rgba(0,0,0,0.3);

z-index:2000;

width:360px;

display:none;

}


/* GRID FILTER */

.filterGrid{

display:grid;

grid-template-columns:1fr 1fr;

gap:15px;

}


.filterTitle{

font-weight:bold;

margin-bottom:6px;

border-bottom:1px solid #ddd;

padding-bottom:3px;

}


/* SCROLL */

.filterList{

max-height:220px;

overflow:auto;

font-size:14px;

}


.filterClose{

margin-top:10px;

width:100%;

padding:8px;

border:none;

background:#0d6efd;

color:white;

border-radius:6px;

cursor:pointer;

}



/* MOBILE */

@media (max-width:768px){

.topbar{

left:10px;
right:10px;
transform:none;

flex-direction:column;

}

.select2-container{
width:100% !important;
}

#map{
height:88vh;
}

.popup-content{
font-size:16px;
}

.filterWindow{

left:10px;
right:10px;
transform:none;
width:auto;

}

.filterGrid{

grid-template-columns:1fr;

}

}


<style>

/* HP */
@media (max-width: 600px) {

.controls {
  font-size: 11px;
  padding: 6px;
}

.controls select,
.controls button {
  font-size: 11px;
  padding: 4px 6px;
}

}

</style>
</style>

</head>


<body>

<div class="topbar">

<select id="bridgeSelect"></select>

<button class="btn btn-go" onclick="focusBridge()">GO</button>

<button class="btn btn-gps" onclick="locateUser()">Posisi Saat Ini</button>

<button class="btn btn-filter" onclick="toggleFilter()">Filter</button>

</div>

<div id="map"></div>



<div id="filterWindow" class="filterWindow">

<div class="filterGrid">


<div>

<div class="filterTitle">PPK</div>

<div id="ppkFilter" class="filterList"></div>

</div>


<div>

<div class="filterTitle">NK S2 2025</div>

<div id="nkFilter" class="filterList"></div>

</div>


</div>


<button class="filterClose" onclick="resetFilter()">
Reset Filter
</button>

<button class="filterClose" onclick="toggleFilter()">
Tutup
</button>

</div>



<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>



<script>


var map=L.map('map').setView([-8.6,115.2],10);


L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
attribution:'Â© OpenStreetMap'
}).addTo(map);



var clusterGroup=L.markerClusterGroup({

maxClusterRadius:25

});


map.addLayer(clusterGroup);



var allRows=[];
var bridgeMarkers={};
var allMarkers=[];
var userMarker=null;



var bridgeIcon=L.icon({

iconUrl:"bridge.png",

iconSize:[40,40],

iconAnchor:[20,40],

popupAnchor:[0,-35]

});



fetch('Data Jembatan.xlsx')

.then(res=>res.arrayBuffer())

.then(data=>{

var workbook=XLSX.read(data);

var sheet=workbook.Sheets[workbook.SheetNames[0]];

var rows=XLSX.utils.sheet_to_json(sheet);


allRows=rows;


loadBridges(rows);

buildFilter(rows);

restoreFilter();

});



function loadBridges(rows){

clusterGroup.clearLayers();

allMarkers=[];


rows.forEach(function(row){

var lat=parseFloat(row.Koordinat_Y);

var lng=parseFloat(row.Koordinat_X);

if(!lat||!lng)return;


var marker=L.marker([lat,lng],{

icon:bridgeIcon

});


clusterGroup.addLayer(marker);


marker.bindTooltip(row.Nama_Jembatan,{

direction:"top",

className:"bridge-label"

});


marker.bindPopup(generatePopup(row));


allMarkers.push(marker);

bridgeMarkers[row.Nama_Jembatan]=marker;


$('#bridgeSelect').append(

new Option(row.Nama_Jembatan,row.Nama_Jembatan)

);


});


$('#bridgeSelect').select2({

placeholder:"Cari Nama Jembatan"

});

}



map.on('zoomend',function(){

var zoom=map.getZoom();

allMarkers.forEach(function(marker){

if(zoom>=15)

marker.openTooltip();

else

marker.closeTooltip();

});

});



function generatePopup(row){

var gmaps=

`https://www.google.com/maps?q=${row.Koordinat_Y},${row.Koordinat_X}`;

return `

<div class="popup-content">

<b style="font-size:16px">

${row.Nama_Jembatan}

</b>

<br><br>

No. Jbt : ${row.No_Jbt}<br>

Tahun Bangun : ${row["Tahun Bangun"]}<br>

Panjang (m) : ${row["Panjang (m)"]}<br>

Lebar Jembatan (m) : ${row["Lebar Jembatan (m)"]}<br>

Lebar Lajur Lalin (m) : ${row["Lebar Lajur Lalin (m)"]}<br>

Jml Bentang : ${row["Jml Bentang"]}<br>

Tipe Bang. Atas : ${row["Tipe Bang. Atas"]}<br>

NK S2 2025 : ${row["NK S2 2025"]}<br>

Ruas Jalan : ${row["Ruas Jalan"]}<br>

PPK : ${row.PPK}<br><br>

<a href="${gmaps}"

target="_blank"

class="gmaps-btn">

Open GMaps

</a>

</div>

`;

}



function focusBridge(){

var name=$('#bridgeSelect').val();

if(bridgeMarkers[name]){

map.setView(

bridgeMarkers[name].getLatLng(),

17

);

bridgeMarkers[name].openPopup();

}

}



function locateUser(){

map.locate({

setView:true,

maxZoom:17

});

}



map.on('locationfound',function(e){

if(userMarker)

map.removeLayer(userMarker);


userMarker=L.marker(e.latlng)

.addTo(map)

.bindPopup("Posisi Anda")

.openPopup();

});


map.on('locationerror',function(){

alert("Tidak bisa mendapatkan lokasi");

});



function toggleFilter(){

var w=document.getElementById("filterWindow");

w.style.display=

(w.style.display=="block")?

"none":"block";

}



function buildFilter(rows){

var ppkSet=new Set();

var nkSet=new Set();


rows.forEach(function(r){

ppkSet.add(r.PPK);

nkSet.add(r["NK S2 2025"]);

});


ppkSet.forEach(function(p){

$('#ppkFilter').append(

`<label>

<input type="checkbox" class="ppkCheck" value="${p}">

${p}

</label><br>`

);

});


nkSet.forEach(function(n){

$('#nkFilter').append(

`<label>

<input type="checkbox" class="nkCheck" value="${n}">

${n}

</label><br>`

);

});


$('.ppkCheck,.nkCheck').change(applyFilter);

}



function applyFilter(){


var ppk=[];

$('.ppkCheck:checked').each(function(){

ppk.push($(this).val());

});


var nk=[];

$('.nkCheck:checked').each(function(){

nk.push($(this).val());

});


localStorage.setItem("ppkFilter",JSON.stringify(ppk));

localStorage.setItem("nkFilter",JSON.stringify(nk));


var filtered=allRows.filter(function(row){

if(ppk.length>0 && !ppk.includes(row.PPK))
return false;

if(nk.length>0 && !nk.includes(String(row["NK S2 2025"])))
return false;

return true;

});


loadBridges(filtered);

}



function restoreFilter(){


var ppk=

JSON.parse(localStorage.getItem("ppkFilter")||"[]");


var nk=

JSON.parse(localStorage.getItem("nkFilter")||"[]");


$('.ppkCheck').each(function(){

if(ppk.includes($(this).val()))
$(this).prop("checked",true);

});


$('.nkCheck').each(function(){

if(nk.includes($(this).val()))
$(this).prop("checked",true);

});


applyFilter();

}

function resetFilter(){

$('.ppkCheck').prop('checked',false);

$('.nkCheck').prop('checked',false);

localStorage.removeItem("ppkFilter");

localStorage.removeItem("nkFilter");

loadBridges(allRows);

}

</script>


</body>
</html>
