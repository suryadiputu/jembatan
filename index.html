<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Peta Aset Jembatan</title>

<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>

<style>

body{
margin:0;
font-family:Segoe UI,Arial;
background:#f5f7fa;
}

#map{
height:92vh;
}

/* TOP PANEL */

.topbar{

position:absolute;
top:10px;
left:50%;
transform:translateX(-50%);

background:white;
padding:10px 14px;

border-radius:10px;
box-shadow:0 3px 10px rgba(0,0,0,0.2);

display:flex;
gap:8px;

z-index:1000;
}

.select2-container{
width:260px !important;
}

.btn{
border:none;
padding:8px 14px;
border-radius:6px;
font-weight:600;
cursor:pointer;
}

.btn-go{
background:#0d6efd;
color:white;
}

.btn-gps{
background:#198754;
color:white;
}

.btn-filter{
background:#6c757d;
color:white;
}


/* FILTER POPUP */

.filter-popup{

display:none;
position:absolute;

top:80px;
left:50%;

transform:translateX(-50%);

background:white;

padding:16px;

border-radius:10px;

box-shadow:0 4px 15px rgba(0,0,0,0.3);

z-index:2000;

width:300px;

max-height:70vh;

overflow:auto;

}

.popup-content{
font-size:14px;
line-height:1.6;
}


.leaflet-popup-content .gmaps-btn{

display:inline-block;
padding:8px 14px;

background:#0d6efd;
color:white !important;

text-decoration:none;

border-radius:6px;

font-size:13px;
font-weight:600;
}


.bridge-label{

font-size:12px;
font-weight:bold;

background:white;

padding:2px 6px;

border-radius:4px;
}


/* SUMMARY BOX */

.summaryBox{

position:absolute;

bottom:20px;
left:50%;

transform:translateX(-50%) scale(0.85);

background:white;

padding:12px 16px;

border-radius:10px;

box-shadow:0 3px 10px rgba(0,0,0,0.25);

z-index:1500;

font-size:14px;

min-width:260px;

}



/* MOBILE */

@media (max-width:600px){

.topbar{

top:5px;
padding:6px 8px;

gap:6px;

border-radius:8px;

}

.select2-container{

width:200px !important;

font-size:13px;
}

.btn{

padding:6px 8px;

font-size:12px;

}

.leaflet-top.leaflet-left{

margin-top:60px;

}

#map{

height:90vh;

}

}

</style>
</head>


<body>


<div class="topbar">

<select id="bridgeSelect"></select>

<button class="btn btn-go" onclick="focusBridge()">
GO
</button>

<button class="btn btn-gps" onclick="locateUser()">
Posisi Saat Ini
</button>

<button class="btn btn-filter" onclick="toggleFilter()">
Filter
</button>

</div>



<div class="filter-popup" id="filterBox">

<b>Filter PPK</b>

<div id="ppkList"></div>

<br>

<b>Filter NK S2 2025</b>

<div id="nkList"></div>

<br>

<button class="btn btn-go" onclick="applyFilter()">
Terapkan
</button>

<button class="btn btn-filter" onclick="resetFilter()">
Reset
</button>

</div>


<div id="map"></div>


<div class="summaryBox" id="summaryBox">
Memuat data...
</div>



<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>



<script>


var map=L.map('map').setView([-8.6,115.2],10);


L.tileLayer(
'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
{attribution:'Â© OpenStreetMap'}
).addTo(map);



var clusterGroup=L.markerClusterGroup({
maxClusterRadius:25
});

map.addLayer(clusterGroup);


var bridgeIcon=L.icon({

iconUrl:"bridge.png",

iconSize:[40,40],

iconAnchor:[20,40],

popupAnchor:[0,-35]

});


var bridgeMarkers={};
var markerObjects=[];
var rowsData=[];
var userMarker=null;



fetch('Data Jembatan.xlsx')

.then(res=>res.arrayBuffer())

.then(data=>{

var workbook=XLSX.read(data);

var sheet=workbook.Sheets[workbook.SheetNames[0]];

rowsData=XLSX.utils.sheet_to_json(sheet);

initUI(rowsData);

loadBridges(rowsData);

});



function initUI(rows){

$('#bridgeSelect').empty();

rows.forEach(r=>{

$('#bridgeSelect').append(
new Option(r.Nama_Jembatan,r.Nama_Jembatan)
);

});


$('#bridgeSelect').select2({

placeholder:"Cari Nama Jembatan"

});


var ppkSet=new Set();
var nkSet=new Set();


rows.forEach(r=>{

ppkSet.add(String(r.PPK).trim());
nkSet.add(String(r["NK S2 2025"]).trim());

});


ppkSet.forEach(v=>{

$("#ppkList").append(
`<label><input type=checkbox value="${v}"> ${v}</label><br>`
);

});


nkSet.forEach(v=>{

$("#nkList").append(
`<label><input type=checkbox value="${v}"> ${v}</label><br>`
);

});


}




function loadBridges(rows){

clusterGroup.clearLayers();

markerObjects=[];


rows.forEach(function(row){

var lat=parseFloat(row.Koordinat_Y);
var lng=parseFloat(row.Koordinat_X);

if(!lat||!lng)return;


var marker=L.marker([lat,lng],{
icon:bridgeIcon
});


marker.rowData=row;


marker.bindTooltip(row.Nama_Jembatan,{
permanent:false,
direction:"top",
className:"bridge-label"
});


marker.bindPopup(generatePopup(row));


clusterGroup.addLayer(marker);

markerObjects.push(marker);


bridgeMarkers[row.Nama_Jembatan]=marker;

});


updateSummary(markerObjects);

}



function updateSummary(markers){

var totalJumlah=0;
var totalPanjang=0;

var nkJumlah={1:0,2:0,3:0,4:0};
var nkPanjang={1:0,2:0,3:0,4:0};


markers.forEach(function(marker){

var r=marker.rowData;

var nk=String(r["NK S2 2025"]).trim();

var panjang=parseFloat(r["Panjang (m)"])||0;


totalJumlah++;
totalPanjang+=panjang;


if(nkJumlah[nk]!=undefined){

nkJumlah[nk]++;
nkPanjang[nk]+=panjang;

}

});


document.getElementById("summaryBox").innerHTML=

"<b>Jumlah total jembatan :</b> "+totalJumlah+" buah | "+totalPanjang.toFixed(0)+" m<br><br>"+

"NK1 : "+nkJumlah[1]+" buah | "+nkPanjang[1].toFixed(0)+" m<br>"+

"NK2 : "+nkJumlah[2]+" buah | "+nkPanjang[2].toFixed(0)+" m<br>"+

"NK3 : "+nkJumlah[3]+" buah | "+nkPanjang[3].toFixed(0)+" m<br>"+

"NK4 : "+nkJumlah[4]+" buah | "+nkPanjang[4].toFixed(0)+" m";

}




function applyFilter(){

var ppk=[];
var nk=[];


$("#ppkList input:checked").each(function(){
ppk.push(String(this.value).trim());
});


$("#nkList input:checked").each(function(){
nk.push(String(this.value).trim());
});


clusterGroup.clearLayers();

var aktif=[];


markerObjects.forEach(function(marker){

var r=marker.rowData;


var ppkValue=String(r.PPK).trim();
var nkValue=String(r["NK S2 2025"]).trim();


if(
(ppk.length===0||ppk.includes(ppkValue))
&&
(nk.length===0||nk.includes(nkValue))
){

clusterGroup.addLayer(marker);
aktif.push(marker);

}

});


updateSummary(aktif);

toggleFilter();

}




function resetFilter(){

$("#ppkList input").prop("checked",false);
$("#nkList input").prop("checked",false);

clusterGroup.clearLayers();

markerObjects.forEach(m=>clusterGroup.addLayer(m));

updateSummary(markerObjects);

}



function toggleFilter(){

var f=document.getElementById("filterBox");

f.style.display=
f.style.display==="block"
? "none":"block";

}



function focusBridge(){

var name=$('#bridgeSelect').val();

if(bridgeMarkers[name]){

map.setView(
bridgeMarkers[name].getLatLng(),
17
);

bridgeMarkers[name].openPopup();

}

}



function locateUser(){

map.locate({
setView:true,
maxZoom:17
});

}



map.on('locationfound',function(e){

if(userMarker)
map.removeLayer(userMarker);


userMarker=L.marker(e.latlng)
.addTo(map)
.bindPopup("Posisi Anda")
.openPopup();

});


map.on('zoomend',function(){

var zoom=map.getZoom();


markerObjects.forEach(function(marker){

if(zoom>=15)
marker.openTooltip();
else
marker.closeTooltip();

});

});


</script>

</body>
</html>
